FROM postgres:15

RUN apt update && \
    apt install -y postgresql-server-dev-15 git libcurl4-openssl-dev make g++ postgresql-15-cron

RUN git clone https://github.com/pramsey/pgsql-http.git

RUN cd pgsql-http && make && make install

RUN rm -rf /pgsql-http && \
    apt-get remove -y git postgresql-server-dev-15 git make g++ && \
    apt-get autoremove --purge -y && \
    apt-get clean && \
    apt-get purge

RUN echo "#!/usr/bin/env bash\n\n\
conf=/var/lib/postgresql/data/postgresql.conf\n\
echo \"shared_preload_libraries = pg_cron\" >> \$conf\n\
echo \"cron.database_name = \"\$POSTGRES_DB\"\" >> \$conf" > /docker-entrypoint-initdb.d/0001_init_pg_cron.sh

RUN chown -R postgres:postgres /docker-entrypoint-initdb.d
